import os
import sys

from buildbot.plugins import worker
from safe_environ import from_env
from registration import get_worker_data, get_secret_data
from architects import (
    buildbot_url,
    builders,
    git_poll,
    pb,
    schedulers,
    secrets,
    postgres,
    www,
)


from safe_environ import from_env
from registration import get_secret_data, get_worker_data



token = from_env("VAULT_TOKEN")
postgres_password = get_secret_data("postgres")
registered_workers = get_worker_data("0.0.0.0", 8200, token)


BuildmasterConfig = {
    "title": "Pipeline",
    "buildbotURL": buildbot_url("0.0.0.0", 8010),
    "workers": [worker.Worker(k, v) for k, v in registered_workers.items()],
    "protocols": pb(9989),
    "www": www(8010),
    "db": postgres("postgres", "default", "postgres", postgres_password),
    "change_source": git_poll("git://github.com/JoelLefkowitz/pub.git", 10),
    "schedulers": schedulers,
    "builders": builders(registered_workers.keys()),
}
